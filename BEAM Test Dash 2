{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "e99e502f",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "BEAM DASHBOARD IS LIVE → http://127.0.0.1:8070\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "\n",
       "        <iframe\n",
       "            width=\"100%\"\n",
       "            height=\"650\"\n",
       "            src=\"http://127.0.0.1:8070/\"\n",
       "            frameborder=\"0\"\n",
       "            allowfullscreen\n",
       "            \n",
       "        ></iframe>\n",
       "        "
      ],
      "text/plain": [
       "<IPython.lib.display.IFrame at 0x13851f790>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import dash\n",
    "from dash import Dash, dcc, html, Input, Output, State, MATCH, ALL, callback_context\n",
    "from dash.exceptions import PreventUpdate\n",
    "import pandas as pd\n",
    "import plotly.express as px\n",
    "import uuid\n",
    "import json\n",
    "\n",
    "# =========================\n",
    "# LOAD DATA\n",
    "# =========================\n",
    "df = pd.read_csv(\"final_data.csv\")\n",
    "if \"BMI\" not in df.columns and {\"Weight (kg)\", \"Height (m)\"}.issubset(df.columns):\n",
    "    df[\"BMI\"] = df[\"Weight (kg)\"] / (df[\"Height (m)\"] ** 2)\n",
    "\n",
    "all_cols = df.columns.tolist()\n",
    "numeric_cols = df.select_dtypes(\"number\").columns.tolist()\n",
    "cat_cols = df.select_dtypes(include=[\"object\", \"category\"]).columns.tolist()\n",
    "\n",
    "chart_types = [\n",
    "    {\"label\": \"Histogram\", \"value\": \"hist\"},\n",
    "    {\"label\": \"Scatter\", \"value\": \"scatter\"},\n",
    "    {\"label\": \"Line\", \"value\": \"line\"},\n",
    "    {\"label\": \"Bar\", \"value\": \"bar\"},\n",
    "    {\"label\": \"Box\", \"value\": \"box\"},\n",
    "    {\"label\": \"Violin\", \"value\": \"violin\"},\n",
    "]\n",
    "\n",
    "agg_opts = [\n",
    "    {\"label\": \"Count\", \"value\": \"count\"},\n",
    "    {\"label\": \"Mean\", \"value\": \"mean\"},\n",
    "    {\"label\": \"Median\", \"value\": \"median\"},\n",
    "    {\"label\": \"Sum\", \"value\": \"sum\"},\n",
    "    {\"label\": \"Min\", \"value\": \"min\"},\n",
    "    {\"label\": \"Max\", \"value\": \"max\"},\n",
    "]\n",
    "\n",
    "# =========================\n",
    "# APP\n",
    "# =========================\n",
    "app = Dash(__name__, suppress_callback_exceptions=True)\n",
    "\n",
    "app.layout = html.Div([\n",
    "    # Header\n",
    "    html.Div([\n",
    "        html.Div(\"BEAM\", style={\"fontSize\":\"48px\",\"fontWeight\":\"bold\",\"color\":\"#00A3E0\",\"letterSpacing\":\"4px\"}),\n",
    "        html.H1(\"Lifestyle Power Dashboard\", style={\"color\":\"white\",\"margin\":\"0 0 0 30px\",\"fontSize\":\"2.5rem\",\"fontWeight\":\"500\"})\n",
    "    ], style={\n",
    "        \"background\": \"linear-gradient(135deg, #002B5B 0%, #001F3F 100%)\",\n",
    "        \"padding\": \"40px 40px\",\n",
    "        \"borderBottom\": \"5px solid #00A3E0\",\n",
    "        \"display\": \"flex\",\n",
    "        \"alignItems\": \"center\",\n",
    "        \"boxShadow\": \"0 10px 20px rgba(0,0,0,0.3)\",\n",
    "        \"position\": \"sticky\",\n",
    "        \"top\": 0,\n",
    "        \"zIndex\": 100\n",
    "    }),\n",
    "\n",
    "    # Main layout\n",
    "    html.Div([\n",
    "        # Sidebar\n",
    "        html.Div([\n",
    "            html.H2(\"Controls\", style={\"color\":\"#002B5B\",\"margin\":\"0 0 20px 0\",\"fontSize\":\"1.8rem\",\"fontWeight\":\"600\"}),\n",
    "\n",
    "            html.Label(\"Global Filter\", style={\"fontWeight\":\"600\",\"marginBottom\":\"8px\",\"display\":\"block\"}),\n",
    "            dcc.Dropdown(id=\"global-filter-col\", options=[{\"label\":c,\"value\":c} for c in all_cols],\n",
    "                         placeholder=\"Select column...\", style={\"marginBottom\":\"10px\"}),\n",
    "            dcc.Dropdown(id=\"global-filter-val\", placeholder=\"Select value...\", style={\"marginBottom\":\"20px\"}),\n",
    "\n",
    "            html.Button(\"Clear Filter\", id=\"clear-filters\", n_clicks=0,\n",
    "                        style={\"width\":\"100%\",\"padding\":\"10px\",\"background\":\"#f8f9fa\",\"border\":\"1px solid #ddd\",\n",
    "                               \"borderRadius\":\"10px\",\"cursor\":\"pointer\",\"fontWeight\":\"600\",\"fontSize\":\"14px\"}),\n",
    "\n",
    "            html.Hr(style={\"borderColor\":\"#ddd\",\"margin\":\"20px 0\"}),\n",
    "\n",
    "            html.Button(\"Add New Chart\", id=\"add-chart\", n_clicks=0,\n",
    "                        style={\"width\":\"100%\",\"padding\":\"16px\",\"background\":\"#00A3E0\",\"color\":\"white\",\n",
    "                               \"border\":\"none\",\"borderRadius\":\"12px\",\"fontSize\":\"16px\",\"fontWeight\":\"600\",\n",
    "                               \"cursor\":\"pointer\",\"boxShadow\":\"0 5px 15px rgba(0,163,224,0.3)\",\n",
    "                               \"transition\":\"all 0.3s ease\"}),\n",
    "\n",
    "        ], style={\n",
    "            \"width\":\"240px\",\n",
    "            \"padding\":\"20px\",\n",
    "            \"borderRight\":\"1px solid #e0e0e0\",\n",
    "            \"height\":\"100%\",\n",
    "            \"float\":\"left\",\n",
    "            \"background\":\"#f9f9f9\"\n",
    "        }),\n",
    "\n",
    "        # Chart grid\n",
    "        html.Div(id=\"chart-grid\", children=[], style={\n",
    "            \"marginLeft\":\"260px\",\n",
    "            \"padding\":\"30px\",\n",
    "            \"minHeight\":\"100vh\",\n",
    "            \"background\":\"#f0f2f5\"\n",
    "        }),\n",
    "    ], style={\"position\":\"relative\"}),\n",
    "\n",
    "    # Modal\n",
    "    html.Div(id=\"modal\", children=[\n",
    "        html.Div([\n",
    "            html.H2(\"Configure Chart\", style={\"margin\":\"0 0 25px 0\",\"color\":\"#002B5B\",\"fontSize\":\"1.8rem\"}),\n",
    "            html.Label(\"Chart Type\", style={\"fontWeight\":\"600\",\"marginBottom\":\"5px\",\"display\":\"block\"}),\n",
    "            dcc.Dropdown(id=\"modal-chart-type\", options=chart_types, style={\"marginBottom\":\"15px\"}),\n",
    "            html.Label(\"Aggregation (for bar/line)\", style={\"fontWeight\":\"600\",\"marginBottom\":\"5px\",\"display\":\"block\"}),\n",
    "            dcc.Dropdown(id=\"modal-agg\", options=agg_opts, placeholder=\"Optional\", style={\"marginBottom\":\"15px\"}),\n",
    "            html.Label(\"X Axis\", style={\"fontWeight\":\"600\",\"marginBottom\":\"5px\",\"display\":\"block\"}),\n",
    "            dcc.Dropdown(id=\"modal-x\", options=[{\"label\":c,\"value\":c} for c in all_cols], style={\"marginBottom\":\"15px\"}),\n",
    "            html.Label(\"Y Axis\", style={\"fontWeight\":\"600\",\"marginBottom\":\"5px\",\"display\":\"block\"}),\n",
    "            dcc.Dropdown(id=\"modal-y\", options=[{\"label\":c,\"value\":c} for c in numeric_cols], style={\"marginBottom\":\"20px\"}),\n",
    "\n",
    "            html.Div([\n",
    "                html.Button(\"Save Changes\", id=\"modal-save\", n_clicks=0,\n",
    "                            style={\"background\":\"#00A3E0\",\"color\":\"white\",\"border\":\"none\",\"padding\":\"10px 24px\",\n",
    "                                   \"borderRadius\":\"10px\",\"fontWeight\":\"600\",\"cursor\":\"pointer\"}),\n",
    "                html.Button(\"Cancel\", id=\"modal-cancel\", n_clicks=0,\n",
    "                            style={\"background\":\"#f0f0f0\",\"marginLeft\":\"10px\",\"padding\":\"10px 24px\",\n",
    "                                   \"borderRadius\":\"10px\",\"cursor\":\"pointer\"})\n",
    "            ], style={\"textAlign\":\"right\"})\n",
    "        ], style={\n",
    "            \"background\":\"white\",\"padding\":\"30px\",\"borderRadius\":\"16px\",\"width\":\"500px\",\n",
    "            \"boxShadow\":\"0 20px 60px rgba(0,0,0,0.3)\",\"border\":\"1px solid #e0e0e0\"\n",
    "        })\n",
    "    ], style={\n",
    "        \"position\":\"fixed\",\"top\":0,\"left\":0,\"right\":0,\"bottom\":0,\n",
    "        \"background\":\"rgba(0,0,0,0.5)\",\"display\":\"none\",\"alignItems\":\"center\",\n",
    "        \"justifyContent\":\"center\",\"zIndex\":9999\n",
    "    }),\n",
    "\n",
    "    dcc.Store(id=\"chart-store\", data={}),\n",
    "    dcc.Store(id=\"active-chart\", data=None)\n",
    "], style={\"margin\":0,\"fontFamily\":\"'Segoe UI', sans-serif\"})\n",
    "\n",
    "# =========================\n",
    "# CALLBACKS\n",
    "# =========================\n",
    "\n",
    "# Global filter value update\n",
    "@app.callback(\n",
    "    Output(\"global-filter-val\", \"options\"),\n",
    "    Input(\"global-filter-col\", \"value\")\n",
    ")\n",
    "def update_global_filter_values(col):\n",
    "    if not col: return []\n",
    "    return [{\"label\": str(v), \"value\": v} for v in df[col].dropna().unique()]\n",
    "\n",
    "# Clear filters\n",
    "@app.callback(\n",
    "    Output(\"global-filter-col\", \"value\"),\n",
    "    Output(\"global-filter-val\", \"value\"),\n",
    "    Input(\"clear-filters\", \"n_clicks\"),\n",
    "    prevent_initial_call=True\n",
    ")\n",
    "def clear_filters(_): return None, None\n",
    "\n",
    "# Manage chart store: add, delete, save modal\n",
    "@app.callback(\n",
    "    Output(\"chart-store\", \"data\", allow_duplicate=True),\n",
    "    Input(\"add-chart\", \"n_clicks\"),\n",
    "    Input({\"type\":\"delete-btn\",\"chart\":ALL},\"n_clicks\"),\n",
    "    Input(\"modal-save\",\"n_clicks\"),\n",
    "    State(\"chart-store\",\"data\"),\n",
    "    State(\"modal-chart-type\",\"value\"),\n",
    "    State(\"modal-agg\",\"value\"),\n",
    "    State(\"modal-x\",\"value\"),\n",
    "    State(\"modal-y\",\"value\"),\n",
    "    State(\"active-chart\",\"data\"),\n",
    "    prevent_initial_call=True\n",
    ")\n",
    "def manage_store(add_n, delete_clicks, save_n, store, m_type, m_agg, m_x, m_y, active_id):\n",
    "    ctx = callback_context\n",
    "    if not ctx.triggered: raise PreventUpdate\n",
    "    trigger = ctx.triggered[0][\"prop_id\"].split(\".\")[0]\n",
    "    if store is None: store = {}\n",
    "\n",
    "    # Add new chart\n",
    "    if trigger == \"add-chart\":\n",
    "        new_id = str(uuid.uuid4())\n",
    "        store[new_id] = {\"type\": None,\"agg\": None,\"x\": None,\"y\": None}\n",
    "        return store\n",
    "\n",
    "    # Delete chart\n",
    "    if trigger.startswith('{\"type\":\"delete-btn\"'):\n",
    "        info = json.loads(trigger)\n",
    "        chart_to_delete = info.get(\"chart\")\n",
    "        if chart_to_delete in store:\n",
    "            store.pop(chart_to_delete)\n",
    "        return store\n",
    "\n",
    "    # Save modal changes\n",
    "    if trigger == \"modal-save\" and active_id:\n",
    "        store[active_id] = {\"type\": m_type,\"agg\": m_agg,\"x\": m_x,\"y\": m_y}\n",
    "        return store\n",
    "\n",
    "    return store\n",
    "\n",
    "# Set active chart for modal\n",
    "@app.callback(\n",
    "    Output(\"active-chart\",\"data\", allow_duplicate=True),\n",
    "    Input({\"type\":\"edit-btn\",\"chart\":ALL},\"n_clicks\"),\n",
    "    Input(\"modal-cancel\",\"n_clicks\"),\n",
    "    State(\"chart-store\",\"data\"),\n",
    "    prevent_initial_call=True\n",
    ")\n",
    "def set_active_chart(edit_clicks, cancel, store):\n",
    "    ctx = callback_context\n",
    "    if not ctx.triggered: raise PreventUpdate\n",
    "    prop = ctx.triggered[0][\"prop_id\"]\n",
    "    if prop == \"modal-cancel.n_clicks\": return None\n",
    "    if edit_clicks:\n",
    "        idxs = [i for i,v in enumerate(edit_clicks) if v]\n",
    "        if idxs: return list(store.keys())[idxs[0]] if store else None\n",
    "    raise PreventUpdate\n",
    "\n",
    "# Populate modal\n",
    "@app.callback(\n",
    "    Output(\"modal\",\"style\"),\n",
    "    Output(\"modal-chart-type\",\"value\"),\n",
    "    Output(\"modal-agg\",\"value\"),\n",
    "    Output(\"modal-x\",\"value\"),\n",
    "    Output(\"modal-y\",\"value\"),\n",
    "    Input(\"active-chart\",\"data\"),\n",
    "    State(\"chart-store\",\"data\")\n",
    ")\n",
    "def populate_modal(active_id, store):\n",
    "    if not active_id:\n",
    "        return {\"display\":\"none\"}, None, None, None, None\n",
    "    meta = store.get(active_id,{})\n",
    "    return ({\"position\":\"fixed\",\"top\":0,\"left\":0,\"right\":0,\"bottom\":0,\n",
    "             \"background\":\"rgba(0,0,0,0.5)\",\"display\":\"flex\",\"alignItems\":\"center\",\n",
    "             \"justifyContent\":\"center\",\"zIndex\":9999},\n",
    "            meta.get(\"type\"),meta.get(\"agg\"),meta.get(\"x\"),meta.get(\"y\"))\n",
    "\n",
    "# Render chart grid\n",
    "@app.callback(\n",
    "    Output(\"chart-grid\",\"children\"),\n",
    "    Input(\"chart-store\",\"data\")\n",
    ")\n",
    "def render_grid(store):\n",
    "    if not store: return []\n",
    "    cards = []\n",
    "    for cid, meta in store.items():\n",
    "        cards.append(html.Div([\n",
    "            html.Div([\n",
    "                html.Button(\"Edit\", {\"type\":\"edit-btn\",\"chart\":cid}, n_clicks=0,\n",
    "                            style={\"background\":\"#fff\",\"border\":\"1px solid #ddd\",\"padding\":\"6px 12px\",\n",
    "                                   \"borderRadius\":\"8px\",\"cursor\":\"pointer\"}),\n",
    "                html.Button(\"Delete\", {\"type\":\"delete-btn\",\"chart\":cid}, n_clicks=0,\n",
    "                            style={\"background\":\"#ffe6e6\",\"border\":\"none\",\"color\":\"#c00\",\"padding\":\"6px 12px\",\n",
    "                                   \"borderRadius\":\"8px\",\"marginLeft\":\"8px\",\"cursor\":\"pointer\"})\n",
    "            ], style={\"textAlign\":\"right\",\"marginBottom\":\"8px\"}),\n",
    "            dcc.Graph(id={\"type\":\"graph\",\"chart\":cid}, style={\"height\":\"400px\"})\n",
    "        ], style={\"background\":\"white\",\"padding\":\"20px\",\"borderRadius\":\"12px\",\n",
    "                  \"boxShadow\":\"0 5px 20px rgba(0,0,0,0.08)\",\"marginBottom\":\"20px\"}))\n",
    "    return cards\n",
    "\n",
    "# Update graph\n",
    "@app.callback(\n",
    "    Output({\"type\":\"graph\",\"chart\":MATCH},\"figure\"),\n",
    "    Input(\"chart-store\",\"data\"),\n",
    "    Input(\"global-filter-col\",\"value\"),\n",
    "    Input(\"global-filter-val\",\"value\"),\n",
    "    Input({\"type\":\"graph\",\"chart\":MATCH},\"id\")\n",
    ")\n",
    "def update_graph(store, fcol, fval, graph_id):\n",
    "    chart_id = graph_id[\"chart\"]\n",
    "    meta = store.get(chart_id,{})\n",
    "    chart_type = meta.get(\"type\")\n",
    "    agg = meta.get(\"agg\")\n",
    "    x = meta.get(\"x\")\n",
    "    y = meta.get(\"y\")\n",
    "    if not chart_type or not x: return px.scatter(title=\"Click Edit to configure\")\n",
    "\n",
    "    df_plot = df.copy()\n",
    "    if fcol and fval is not None:\n",
    "        df_plot = df_plot[df_plot[fcol] == fval]\n",
    "\n",
    "    if chart_type in (\"bar\",\"line\") and agg and y:\n",
    "        try:\n",
    "            if agg==\"count\":\n",
    "                df_plot = df_plot.groupby(x)[y].count().reset_index(name=y)\n",
    "            else:\n",
    "                df_plot = df_plot.groupby(x)[y].agg(agg).reset_index()\n",
    "        except: pass\n",
    "\n",
    "    try:\n",
    "        if chart_type==\"hist\": fig = px.histogram(df_plot,x=x,title=f\"Distribution of {x}\")\n",
    "        elif chart_type==\"scatter\": fig = px.scatter(df_plot,x=x,y=y,title=f\"{y} vs {x}\")\n",
    "        elif chart_type==\"line\": fig = px.line(df_plot,x=x,y=y,title=f\"{y} over {x}\")\n",
    "        elif chart_type==\"bar\": fig = px.bar(df_plot,x=x,y=y,title=f\"{y} by {x}\")\n",
    "        elif chart_type==\"box\": fig = px.box(df_plot,x=x,y=y) if y else px.box(df_plot,y=x)\n",
    "        elif chart_type==\"violin\": fig = px.violin(df_plot,x=x,y=y,box=True,points=\"all\") if y else px.violin(df_plot,y=x)\n",
    "        else: fig = px.scatter(title=\"Invalid\")\n",
    "    except:\n",
    "        fig = px.scatter(title=\"Invalid config\")\n",
    "\n",
    "    fig.update_layout(margin=dict(t=60), height=400)\n",
    "    return fig\n",
    "\n",
    "# =========================\n",
    "# RUN\n",
    "# =========================\n",
    "print(\"BEAM DASHBOARD IS LIVE → http://127.0.0.1:8070\")\n",
    "app.run_server(debug=True, port=8070)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "768e0a56",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
